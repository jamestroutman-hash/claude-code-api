# Claude Code API Gateway

A simple, focused OpenAI-compatible API gateway for Claude Code with streaming support.
Leverage the Claude Code SDK use mode. Don't hack the token credentials.

## Getting Started

Use the Makefile to install the project or pip/uv.

![API Started](assets/api.png)

![Cline use](assets/cline.png)

![Cursor](assets/cursor.png)

![OpenWebUI](assets/openwebui.png)

![Roo Code config](assets/roocode.png)

![Roo Code chat](assets/roo_code.png)

### Docker Deployment (Recommended)

The easiest way to get started is using Docker:

```bash
# Clone the repository
git clone https://github.com/codingworkflow/claude-code-api
cd claude-code-api

# Copy environment template and add your API key
cp .env.example .env
# Edit .env and set your ANTHROPIC_API_KEY

# Build and start with Docker Compose
docker-compose up -d

# View logs
docker-compose logs -f

# Test the API
curl http://localhost:8000/health
```

The API will be available at http://localhost:8000

**Stop the container:**
```bash
docker-compose down
```

**Rebuild after changes:**
```bash
docker-compose up -d --build
```

### Python Implementation
```bash
# Clone and setup
git clone https://github.com/codingworkflow/claude-code-api
cd claude-code-api

# Install dependencies & module
make install 

# Start the API server
make start
```

## Limitations

- There might be a limit on maximum input below normal "Sonnet 4" input as Claude Code usually doesn't ingest more than 25k tokens (despite the context being 100k).
- Claude Code auto-compacts context beyond 100k.
- Currently runs with bypass mode to avoid tool errors.
- Claude Code tools may need to be disabled to avoid overlap and background usage.
- Runs only on Linux/Mac as Claude Code doesn't run on Windows (you can use WSL).
- Note that Claude Code will default to accessing the current workspace environment/folder and is set to use bypass mode.


## Features

- **Claude-Only Models**: Supports exactly the 4 Claude models that Claude Code CLI offers
- **OpenAI Compatible**: Drop-in replacement for OpenAI API endpoints
- **Streaming Support**: Real-time streaming responses 
- **Simple & Clean**: No over-engineering, focused implementation
- **Claude Code Integration**: Leverages Claude Code CLI with streaming output

## Supported Models

- `claude-opus-4-20250514` - Claude Opus 4 (Most powerful)
- `claude-sonnet-4-20250514` - Claude Sonnet 4 (Latest Sonnet)
- `claude-3-7-sonnet-20250219` - Claude Sonnet 3.7 (Advanced)
- `claude-3-5-haiku-20241022` - Claude Haiku 3.5 (Fast & cost-effective)

## Quick Start

### Prerequisites

**For Docker (Recommended):**
- Docker and Docker Compose installed
- Valid Anthropic API key from https://console.anthropic.com/

**For Python Installation:**
- Python 3.10+
- Claude Code CLI installed and accessible
- Valid Anthropic API key configured in Claude Code (ensure it works in current directory src/)

### Installation & Setup

```bash
# Clone and setup
git clone https://github.com/codingworkflow/claude-code-api
cd claude-code-api

# Install dependencies
make install

# Run tests to verify setup
make test

# Start the API server
make start-dev
```

The API will be available at:
- **API**: http://localhost:8000
- **Docs**: http://localhost:8000/docs  
- **Health**: http://localhost:8000/health

## Makefile Commands

### Core Commands
```bash
make install     # Install production dependencies
make install-dev # Install development dependencies  
make test        # Run all tests
make start       # Start API server (production)
make start-dev   # Start API server (development with reload)
```

### Testing
```bash
make test           # Run all tests
make test-fast      # Run tests (skip slow ones)
make test-hello     # Test hello world with Haiku
make test-health    # Test health check only
make test-models    # Test models API only
make test-chat      # Test chat completions only
make quick-test     # Quick validation of core functionality
```

### Development
```bash
make dev-setup      # Complete development setup
make lint           # Run linting checks
make format         # Format code with black/isort
make type-check     # Run type checking
make clean          # Clean up cache files
```

### Information
```bash
make help           # Show all available commands
make models         # Show supported Claude models
make info           # Show project information
make check-claude   # Check if Claude Code CLI is available
```

## API Usage

### Chat Completions

```bash
curl -X POST http://localhost:8000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{
    "model": "claude-3-5-haiku-20241022",
    "messages": [
      {"role": "user", "content": "Hello!"}
    ]
  }'
```

### List Models

```bash
curl http://localhost:8000/v1/models
```

### Streaming Chat

```bash
curl -X POST http://localhost:8000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{
    "model": "claude-3-5-haiku-20241022", 
    "messages": [
      {"role": "user", "content": "Tell me a joke"}
    ],
    "stream": true
  }'
```

## Project Structure

```
claude-code-api/
├── claude_code_api/
│   ├── main.py              # FastAPI application
│   ├── api/                 # API endpoints
│   │   ├── chat.py          # Chat completions
│   │   ├── models.py        # Models API
│   │   ├── projects.py      # Project management
│   │   └── sessions.py      # Session management
│   ├── core/                # Core functionality
│   │   ├── auth.py          # Authentication
│   │   ├── claude_manager.py # Claude Code integration
│   │   ├── session_manager.py # Session management
│   │   ├── config.py        # Configuration
│   │   └── database.py      # Database layer
│   ├── models/              # Data models
│   │   ├── claude.py        # Claude-specific models
│   │   └── openai.py        # OpenAI-compatible models
│   ├── utils/               # Utilities
│   │   ├── streaming.py     # Streaming support
│   │   └── parser.py        # Output parsing
│   └── tests/               # Test suite
├── Dockerfile               # Docker image configuration
├── Dockerfile.secure        # Secure Docker build with secrets
├── docker-compose.yml       # Docker Compose orchestration
├── .dockerignore           # Docker build exclusions
├── .env.example            # Environment variables template
├── render.yaml             # Render.com deployment config
├── DEPLOY.md               # Deployment guide
├── .claude-config/         # Claude Code config (gitignored)
├── copy-claude-config.sh   # Helper script to copy config
├── build-and-push.sh       # Build and push Docker image
├── Makefile                # Development commands
├── pyproject.toml          # Project configuration
├── setup.py                # Package setup
└── README.md               # This file
```

## Testing

The test suite validates:
- Health check endpoints
- Models API (Claude models only)
- Chat completions with Haiku model
- Hello world functionality
- OpenAI compatibility (structure)
- Error handling

Run specific test suites:
```bash
make test-hello    # Test hello world with Haiku
make test-models   # Test models API
make test-chat     # Test chat completions
```

## Development

### Setup Development Environment
```bash
make dev-setup
```

### Code Quality
```bash
make format        # Format code
make lint          # Check linting
make type-check    # Type checking
```

### Quick Validation
```bash
make quick-test    # Test core functionality
```

## Deployment

### Docker Deployment

#### Using Docker Compose (Recommended)

```bash
# Start the container
docker-compose up -d

# View logs
docker-compose logs -f

# Stop the container
docker-compose down

# Rebuild after code changes
docker-compose up -d --build
```

#### Using Docker CLI

```bash
# Build the image
docker build -t claude-code-api .

# Run the container
docker run -d \
  --name claude-code-api \
  -p 8000:8000 \
  -e ANTHROPIC_API_KEY=your_api_key_here \
  -v $(pwd)/data:/app/data \
  claude-code-api

# Check logs
docker logs -f claude-code-api

# Stop the container
docker stop claude-code-api
docker rm claude-code-api
```

#### Docker Environment Variables

Configure the container using environment variables in `.env` or `docker-compose.yml`:

- `ANTHROPIC_API_KEY` - Your Anthropic API key (required)
- `PORT` - Server port (default: 8000)
- `HOST` - Server host (default: 0.0.0.0)
- `REQUIRE_AUTH` - Enable authentication (default: false)
- `DATABASE_URL` - Database connection string
- `LOG_LEVEL` - Logging level (default: INFO)

#### Docker Features

- Multi-stage build for smaller image size
- Health checks for container monitoring
- Persistent data storage via volumes
- Automatic restart on failure
- Resource limits to prevent overconsumption

### Deploying to Render.com

For cloud deployment with your Claude Code authentication:

#### Quick Start (3 commands)

```bash
# 1. Copy your Claude Code config
./copy-claude-config.sh

# 2. Build and push to Docker Hub
./build-and-push.sh --user your-dockerhub-username --push

# 3. Deploy on Render.com using your Docker image
```

#### Detailed Steps

**Step 1: Copy Your Claude Code Config**

```bash
# Use the helper script (recommended)
./copy-claude-config.sh

# Or manually copy
mkdir -p .claude-config
cp -r ~/.config/claude/* .claude-config/
```

**IMPORTANT**: The `.claude-config/` directory is gitignored to protect your tokens!

**Step 2: Build and Push Docker Image**

```bash
# Build with your config and push to Docker Hub
./build-and-push.sh --user your-dockerhub-username --push

# Or manually:
docker build -t your-username/claude-code-api:latest .
docker push your-username/claude-code-api:latest
```

**Step 3: Deploy on Render**

1. Go to [Render Dashboard](https://dashboard.render.com/)
2. Click "New" → "Private Service"
3. Select "Deploy an existing image"
4. Enter your image: `your-username/claude-code-api:latest`
5. Set environment variable: `ANTHROPIC_API_KEY`
6. Click "Create Web Service"

Your API will be available at: `https://your-service-name.onrender.com`

For more deployment options and detailed instructions, see [DEPLOY.md](DEPLOY.md)

### Check Deployment Readiness
```bash
make deploy-check
```

### Production Server
```bash
make start-prod    # Start with multiple workers
```
Use http://127.0.0.1:8000/v1 as OpenAPI endpoint

## Configuration

Key settings in `claude_code_api/core/config.py`:
- `claude_binary_path`: Path to Claude Code CLI
- `project_root`: Root directory for projects
- `database_url`: Database connection string
- `require_auth`: Enable/disable authentication

## Design Principles

1. **Simple & Focused**: No over-engineering
2. **Claude-Only**: Pure Claude gateway, no OpenAI models
3. **Streaming First**: Built for real-time streaming
4. **OpenAI Compatible**: Drop-in API compatibility
5. **Test-Driven**: Comprehensive test coverage

## Health Check

```bash
curl http://localhost:8000/health
```

Response:
```json
{
  "status": "healthy",
  "version": "1.0.0", 
  "claude_version": "1.x.x",
  "active_sessions": 0
}
```

## License

This project is licensed under the GNU General Public License v3.0 - see the LICENSE file for details.
"""Admin endpoints for Claude Code management."""

import asyncio
import json
from typing import Optional
from fastapi import APIRouter, HTTPException
from fastapi.responses import StreamingResponse, HTMLResponse
from pydantic import BaseModel
import structlog

from ..core.config import settings

logger = structlog.get_logger()

router = APIRouter(prefix="/admin", tags=["admin"])


@router.get("/console", response_class=HTMLResponse)
async def admin_console():
    """Serve the admin console HTML interface."""
    import os
    html_path = os.path.join(os.path.dirname(__file__), "..", "..", "test-admin.html")

    if not os.path.exists(html_path):
        # Inline fallback HTML
        return HTMLResponse("""
        <!DOCTYPE html>
        <html>
        <head><title>Admin Console</title></head>
        <body>
            <h1>Admin Console</h1>
            <p>HTML file not found. Please access the admin API endpoints directly:</p>
            <ul>
                <li>GET /admin/status - Check status</li>
                <li>POST /admin/set-api-key - Set API key</li>
                <li>POST /admin/execute - Execute command</li>
                <li>POST /admin/login - Login to Claude</li>
            </ul>
            <p>View API docs at <a href="/docs">/docs</a></p>
        </body>
        </html>
        """)

    with open(html_path, "r") as f:
        return HTMLResponse(content=f.read())


class CommandRequest(BaseModel):
    """Request to execute a Claude Code command."""
    command: str
    args: list[str] = []
    cwd: Optional[str] = None


class CommandResponse(BaseModel):
    """Response from command execution."""
    success: bool
    exit_code: int
    output: str
    error: str


async def stream_command_output(cmd: list[str], cwd: Optional[str] = None):
    """Execute a command and stream its output."""
    try:
        logger.info(
            "Executing admin command",
            command=" ".join(cmd),
            cwd=cwd
        )

        # Start the process
        process = await asyncio.create_subprocess_exec(
            *cmd,
            cwd=cwd or "/app",
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE,
            stdin=asyncio.subprocess.PIPE
        )

        # Stream stdout
        async def read_stream(stream, stream_name):
            while True:
                line = await stream.readline()
                if not line:
                    break

                text = line.decode('utf-8', errors='replace')
                yield json.dumps({
                    "type": "stream",
                    "stream": stream_name,
                    "data": text
                }) + "\n"

        # Read both stdout and stderr
        async for chunk in read_stream(process.stdout, "stdout"):
            yield chunk

        async for chunk in read_stream(process.stderr, "stderr"):
            yield chunk

        # Wait for process to complete
        await process.wait()

        # Send final status
        yield json.dumps({
            "type": "complete",
            "exit_code": process.returncode,
            "success": process.returncode == 0
        }) + "\n"

    except Exception as e:
        logger.error(
            "Command execution failed",
            error=str(e)
        )
        yield json.dumps({
            "type": "error",
            "error": str(e)
        }) + "\n"


@router.post("/execute", response_class=StreamingResponse)
async def execute_command(request: CommandRequest):
    """
    Execute a Claude Code command and stream the output.

    This endpoint allows you to run any Claude Code command, including:
    - /login - Authenticate with Anthropic
    - /logout - Log out
    - /status - Check current status
    - Any other Claude CLI command

    Example:
    ```json
    {
        "command": "claude",
        "args": ["/login"]
    }
    ```
    """
    # Build the full command
    cmd = [request.command] + request.args

    # Security: Only allow claude commands
    if request.command not in ["claude", settings.claude_binary_path]:
        raise HTTPException(
            status_code=400,
            detail="Only Claude Code commands are allowed"
        )

    return StreamingResponse(
        stream_command_output(cmd, request.cwd),
        media_type="application/x-ndjson"
    )


@router.post("/login")
async def login():
    """
    Initiate Claude Code login flow.

    This will start the interactive login process.
    You'll receive a URL to visit in your browser to authenticate.
    """
    cmd = [settings.claude_binary_path, "/login"]

    return StreamingResponse(
        stream_command_output(cmd),
        media_type="application/x-ndjson"
    )


@router.post("/set-api-key")
async def set_api_key(api_key: str):
    """
    Set the Anthropic API key directly via environment variable.

    Note: This sets the key for the current session only.
    For persistent configuration, use the /login endpoint or
    set ANTHROPIC_API_KEY environment variable.
    """
    import os
    os.environ['ANTHROPIC_API_KEY'] = api_key

    # Test the key by running a simple command
    cmd = [settings.claude_binary_path, "--version"]

    try:
        process = await asyncio.create_subprocess_exec(
            *cmd,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE,
            env={**os.environ, 'ANTHROPIC_API_KEY': api_key}
        )
        stdout, stderr = await process.communicate()

        if process.returncode == 0:
            return {
                "success": True,
                "message": "API key set successfully",
                "version": stdout.decode().strip()
            }
        else:
            return {
                "success": False,
                "message": "Failed to validate API key",
                "error": stderr.decode()
            }
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to set API key: {str(e)}"
        )


@router.get("/status")
async def get_status():
    """Get Claude Code status and configuration."""
    cmd = [settings.claude_binary_path, "--version"]

    try:
        process = await asyncio.create_subprocess_exec(
            *cmd,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE
        )
        stdout, stderr = await process.communicate()

        import os
        return {
            "claude_binary": settings.claude_binary_path,
            "claude_version": stdout.decode().strip() if process.returncode == 0 else "unknown",
            "has_api_key": "ANTHROPIC_API_KEY" in os.environ,
            "config_directory": os.path.expanduser("~/.config/claude")
        }
    except Exception as e:
        return {
            "error": str(e),
            "claude_binary": settings.claude_binary_path
        }

'use client';

import { useState } from 'react';
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import rehypeRaw from 'rehype-raw';
import rehypeSanitize from 'rehype-sanitize';
import { EditFeatureModal } from './EditFeatureModal';

interface FeatureHeaderProps {
  feature: {
    id: string;
    key: string | null;
    title: string;
    description?: string | null;
    status: string;
    priority?: string | null;
    start_date?: string | null;
    target_date?: string | null;
    business_value?: string | null;
    target_users?: string | null;
    functional_areas?: { id: string; name: string } | null;
    monday_item_id?: string | null;
  };
  confluenceBaseUrl?: string;
  confluenceSpaceKey?: string;
  confluencePageId?: string | null;
  mondayBoardId?: string | null;
  hasConfluenceContent?: boolean;
}

/**
 * Feature header component displaying key metadata and edit controls
 * @see /docs/specs/feature-spec.md#BR-003
 * @see /docs/specs/feature-spec.md#BR-004
 * @see /docs/specs/feature-spec.md#BR-005
 * @see /docs/specs/feature-spec.md#BR-006
 * @see /docs/specs/feature-spec.md#BR-009
 * Displays feature key (BR-003), title/description (BR-004), status (BR-005),
 * priority (BR-006), and functional area (BR-009)
 */
export function FeatureHeader({ feature, confluenceBaseUrl, confluenceSpaceKey, confluencePageId, mondayBoardId, hasConfluenceContent }: FeatureHeaderProps) {
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);

  return (
    <>
      <div className="mb-4">
        <div className="flex items-start justify-between">
          <div className="flex-1">
            <div className="flex items-center gap-3 mb-2">
              <span className="text-sm font-mono text-gray-500">{feature.key}</span>
              {/* Status pill */}
              <span
                className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${
                  feature.status === 'in_progress'
                    ? 'bg-blue-100 text-blue-800'
                    : feature.status === 'completed'
                    ? 'bg-green-100 text-green-800'
                    : feature.status === 'discovery'
                    ? 'bg-purple-100 text-purple-800'
                    : 'bg-gray-100 text-gray-800'
                }`}
              >
                {feature.status}
              </span>
              {/* Priority pill */}
              <span
                className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${
                  feature.priority === 'critical'
                    ? 'bg-red-100 text-red-800'
                    : feature.priority === 'high'
                    ? 'bg-orange-100 text-orange-800'
                    : feature.priority === 'medium'
                    ? 'bg-yellow-100 text-yellow-800'
                    : 'bg-gray-100 text-gray-800'
                }`}
              >
                {feature.priority}
              </span>
              {/* Functional Area pill */}
              {feature.functional_areas && (
                <span className="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-indigo-100 text-indigo-800">
                  {feature.functional_areas.name}
                </span>
              )}
            </div>

            {/* External Links - Confluence and Monday.com */}
            <div className="flex items-center gap-4 mb-3 text-sm">
              {confluencePageId && confluenceBaseUrl && confluenceSpaceKey && (
                <a
                  href={`${confluenceBaseUrl}/wiki/spaces/${confluenceSpaceKey}/pages/${confluencePageId}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="inline-flex items-center gap-1.5 text-blue-600 hover:text-blue-800 hover:underline"
                >
                  <svg className="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm0 22c-5.523 0-10-4.477-10-10s4.477-10 10-10 10 4.477 10 10-4.477 10-10 10zm1-11h-2v-6h2v6zm0 4h-2v-2h2v2z"/>
                  </svg>
                  View in Confluence
                </a>
              )}
              {feature.monday_item_id && mondayBoardId && (
                <a
                  href={`https://veritasprime-products.monday.com/boards/${mondayBoardId}/pulses/${feature.monday_item_id}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="inline-flex items-center gap-1.5 text-blue-600 hover:text-blue-800 hover:underline"
                >
                  <svg className="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                  View in Monday.com
                </a>
              )}
            </div>
            <h1 className="text-3xl font-bold text-gray-900">{feature.title}</h1>
            {/* Only show description if there's no Confluence content */}
            {!hasConfluenceContent && feature.description && (
              <div className="mt-4 prose prose-sm max-w-none prose-headings:text-gray-900 prose-p:text-gray-700 prose-a:text-blue-600 prose-strong:text-gray-900 prose-code:text-pink-600 prose-code:bg-gray-100 prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-pre:bg-gray-900 prose-pre:text-gray-100">
                <ReactMarkdown
                  remarkPlugins={[remarkGfm]}
                  rehypePlugins={[rehypeRaw, rehypeSanitize]}
                >
                  {feature.description}
                </ReactMarkdown>
              </div>
            )}
          </div>

          <button
            onClick={() => setIsEditModalOpen(true)}
            className="ml-4 rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
          >
            Edit
          </button>
        </div>
      </div>

      <EditFeatureModal
        feature={feature}
        isOpen={isEditModalOpen}
        onClose={() => setIsEditModalOpen(false)}
      />
    </>
  );
}

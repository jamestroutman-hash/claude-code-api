# Deployment Guide

## Deploying to Render.com

### Prerequisites
- Render.com account
- Your local Claude Code configuration and authentication tokens

### Step 1: Prepare Claude Code Config

First, copy your local Claude Code configuration into the Docker build:

#### Option A: Using the Helper Script (Recommended)

```bash
./copy-claude-config.sh
```

This script will:
- Automatically find your Claude Code config
- Copy it to `.claude-config/`
- Verify the copy was successful
- Show security warnings

#### Option B: Manual Copy

```bash
# Copy your Claude Code config to the project
mkdir -p .claude-config
cp -r ~/.config/claude/* .claude-config/

# Verify the files were copied
ls -la .claude-config/
```

**IMPORTANT**: Never commit the `.claude-config/` directory to git! It's already in `.gitignore`.

### Step 2: Choose Your Deployment Method

Since `.claude-config/` is gitignored (for security), Render won't have access to it when building from GitHub. You have three options:

#### Option A: Build Locally and Push to Registry (Recommended for Security)

```bash
# Build the image locally (with your config)
docker build -t your-username/claude-code-api:latest .

# Push to Docker Hub (or other registry)
docker login
docker push your-username/claude-code-api:latest

# Then deploy this image on Render
```

In Render:
1. Create a "Private Service"
2. Use Docker image: `your-username/claude-code-api:latest`
3. Set environment variables

#### Option B: Use Render Build Secret (Advanced)

Create a `.tar.gz` of your config:
```bash
tar -czf claude-config.tar.gz -C .claude-config .
base64 claude-config.tar.gz > claude-config.b64
```

Add this build command to your Dockerfile or render.yaml:
```bash
echo "$CLAUDE_CONFIG_B64" | base64 -d | tar -xzf - -C /root/.config/claude/
```

Set `CLAUDE_CONFIG_B64` as a secret environment variable in Render.

#### Option C: Public Deployment (Use ANTHROPIC_API_KEY)

If you don't want to bake credentials into the image:

1. Don't copy `.claude-config/`
2. Rely solely on the `ANTHROPIC_API_KEY` environment variable
3. Push code to GitHub normally:

```bash
git add .
git commit -m "Add Docker configuration"
git push origin main
```

4. Deploy on Render with `ANTHROPIC_API_KEY` set

**Note**: This option requires Claude Code CLI to support auth via environment variable.

### Step 3: Deploy to Render

#### Option A: Using render.yaml (Recommended)

1. Go to [Render Dashboard](https://dashboard.render.com/)
2. Click "New" → "Blueprint"
3. Connect your Git repository
4. Render will automatically detect `render.yaml`
5. Set the `ANTHROPIC_API_KEY` environment variable:
   - Click on your service
   - Go to "Environment"
   - Add `ANTHROPIC_API_KEY` with your API key

#### Option B: Manual Setup

1. Go to [Render Dashboard](https://dashboard.render.com/)
2. Click "New" → "Web Service"
3. Connect your Git repository
4. Configure the service:
   - **Name**: claude-code-api
   - **Environment**: Docker
   - **Region**: Oregon (or your preferred region)
   - **Plan**: Starter (or higher)
   - **Dockerfile Path**: ./Dockerfile
   - **Docker Context**: .

5. Set Environment Variables:
   - `ANTHROPIC_API_KEY`: Your Anthropic API key (Secret)
   - `PORT`: 8000
   - `HOST`: 0.0.0.0
   - `REQUIRE_AUTH`: false
   - `LOG_LEVEL`: INFO

6. Set Health Check Path: `/health`

7. Click "Create Web Service"

### Step 4: Build with Claude Config

The Dockerfile will automatically copy your Claude Code config from `.claude-config/` into the container at `/root/.config/claude/`.

### Step 5: Access Your API

Once deployed, your API will be available at:
```
https://your-service-name.onrender.com
```

Test it:
```bash
curl https://your-service-name.onrender.com/health
curl https://your-service-name.onrender.com/v1/models
```

## Alternative: Environment Variable Auth

If you prefer not to bake credentials into the image, you can pass the Anthropic API key as an environment variable. Claude Code CLI will use `ANTHROPIC_API_KEY` from the environment if available.

This is already configured in the `render.yaml` file.

## Security Considerations

### For Baked-in Credentials (Current Approach)
- **Pros**:
  - Simpler deployment
  - No additional configuration needed
- **Cons**:
  - Credentials are in the Docker image
  - Anyone with access to the image can extract them
- **Recommended for**: Personal projects, development environments

### For Environment Variable Auth
- **Pros**:
  - More secure
  - Credentials not in image
  - Easy to rotate keys
- **Cons**:
  - Requires Claude Code to support env var auth
- **Recommended for**: Production deployments

## Updating Your Deployment

To update with new code or config:

```bash
# Update your code
git add .
git commit -m "Update changes"
git push origin main
```

Render will automatically rebuild and deploy.

To update Claude Code config:

```bash
# Copy updated config
cp -r ~/.config/claude/* .claude-config/

# Trigger rebuild on Render
# Option 1: Push a commit
git commit --allow-empty -m "Rebuild with updated config"
git push origin main

# Option 2: Manual deploy from Render dashboard
```

## Troubleshooting

### Build Fails

Check Render logs:
1. Go to your service in Render dashboard
2. Click "Logs" tab
3. Look for build errors

Common issues:
- Missing `.claude-config/` files
- Incorrect Dockerfile path
- Out of memory during build (upgrade plan)

### Service Fails to Start

Check runtime logs in Render dashboard.

Common issues:
- Missing `ANTHROPIC_API_KEY`
- Claude Code config not found
- Port configuration mismatch

### Authentication Issues

If Claude Code can't authenticate:
1. Verify your local `claude-code` works
2. Check that `.claude-config/` was copied correctly
3. Ensure files have correct permissions
4. Try passing `ANTHROPIC_API_KEY` as environment variable

## Monitoring

Render provides:
- Automatic health checks (configured to `/health`)
- Auto-restart on failure
- Deployment logs
- Runtime logs

Monitor your service:
```bash
# Check health
curl https://your-service-name.onrender.com/health

# View logs in Render dashboard
```

## Scaling

To handle more traffic:
1. Go to your service in Render dashboard
2. Click "Settings"
3. Upgrade to a higher plan (Standard or Pro)
4. Enable horizontal scaling if needed

## Cost Considerations

- **Free Tier**: Available but spins down after inactivity
- **Starter**: $7/month, always on
- **Standard**: $25/month, more resources
- **Pro**: $85/month, high performance

Plus Anthropic API usage costs.

## Alternative: Using Render Build Command

If you want more control, you can also use a build command approach. Add to `render.yaml`:

```yaml
buildCommand: |
  mkdir -p /root/.config/claude
  echo "$CLAUDE_CONFIG" | base64 -d > /root/.config/claude/config.json
```

Then set `CLAUDE_CONFIG` as a base64-encoded environment variable with your config.

## Support

For issues:
- Render-specific: [Render Support](https://render.com/docs)
- Claude Code API: [GitHub Issues](https://github.com/codingworkflow/claude-code-api/issues)
